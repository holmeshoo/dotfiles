name: Dotfiles CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      msg:
        type: string
        required: false
        description: "any message"


jobs:
  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      # - name: Uninstall pre-installed tools (Simulate fresh OS)
      #   run: |
      #     echo "Uninstalling Homebrew..."
      #     /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"
      #     sudo rm -f /etc/paths.d/homebrew
      #     sudo rm -rf /opt/homebrew
      #     echo "Uninstalling xcode..."
      #     sudo rm -rf /Library/Developer/CommandLineTools
      #     echo "Simulated a fresh macOS environment."

      - name: Setup Dotfiles (macOS)
        run: |
          # Use explicit flags for non-interactive setup in CI
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/holmeshoo/dotfiles/main/scripts/install.sh)" -- --core --runtime
        env:
          SUDO_ASKPASS: /usr/bin/true

      - name: Verify Installation (macOS)
        run: |
          export PATH="/opt/homebrew/bin:/usr/local/bin:$HOME/.local/bin:$PATH"
          bash scripts/verify.sh

  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Dotfiles (Linux)
        run: |
          # Use explicit flags for non-interactive setup in CI
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/holmeshoo/dotfiles/main/scripts/install.sh)" -- --core --runtime

      - name: Verify Installation (Linux)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          bash scripts/verify.sh

  test-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Dotfiles (Windows)
        shell: pwsh
        run: |
          # Windows execution
          .\scripts\install.ps1
        env:
          CI: true

      - name: Verify Installation (Windows)
        shell: pwsh
        run: |
          # Check symlinks
          $files = @(".gitconfig", ".vimrc", ".editorconfig", ".functions")
          foreach ($f in $files) {
            $path = Join-Path $HOME $f
            if (Test-Path $path) {
              Write-Host "✓ Found: $f"
            } else {
              Write-Error "✗ Missing: $f"
              exit 1
            }
          }
          
          # Check commands
          $cmds = @("git", "micro")
          foreach ($c in $cmds) {
            if (Get-Command $c -ErrorAction SilentlyContinue) {
              Write-Host "✓ Command available: $c"
            } else {
              Write-Warning "✗ Command missing: $c"
            }
          }
