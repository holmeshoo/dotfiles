name: Dotfiles CI

on:
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:
    inputs:
      msg:
        type: string
        required: false
        description: "any message"


jobs:
  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Uninstall pre-installed tools (Simulate fresh OS)
        run: |
          echo "Uninstalling Homebrew..."
          curl -fsSL -o uninstall_brew.sh https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh
          chmod +x uninstall_brew.sh
          ./uninstall_brew.sh --force || true
          
          echo "Forcibly removing remaining Homebrew/Xcode files..."
          # システムフラグ（変更禁止など）を解除してから削除
          sudo chflags -R nouchg /opt/homebrew /usr/local/Homebrew 2>/dev/null || true
          sudo rm -rf /opt/homebrew
          sudo rm -rf /usr/local/Homebrew
          sudo rm -rf /usr/local/bin/brew
          sudo rm -rf /etc/paths.d/homebrew
          sudo rm -rf /Library/Developer/CommandLineTools
          sudo xcode-select --reset || true
          
          # 削除できたか確認（デバッグ用）
          if [ -d "/opt/homebrew" ]; then
            echo "Warning: /opt/homebrew still exists. Listing contents:"
            ls -la /opt/homebrew
          fi
          
          echo "Simulated a fresh macOS environment."

      - name: Setup Dotfiles (macOS)
        run: |
          chmod +x scripts/*.sh
          ./scripts/install.sh
        env:
          SUDO_ASKPASS: /usr/bin/true

      - name: Verify Installation (macOS)
        run: |
          export PATH="/opt/homebrew/bin:/usr/local/bin:$HOME/.local/bin:$PATH"
          bash scripts/verify.sh

  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Dotfiles (Linux)
        run: |
          chmod +x scripts/*.sh
          ./scripts/install.sh

      - name: Verify Installation (Linux)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          bash scripts/verify.sh

  test-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Dotfiles (Windows)
        shell: pwsh
        run: |
          .\scripts\install.ps1
        env:
          CI: true

      - name: Verify Installation (Windows)
        shell: pwsh
        run: |
          # Check symlinks
          $files = @(".gitconfig", ".vimrc", ".editorconfig", ".functions")
          foreach ($f in $files) {
            $path = Join-Path $HOME $f
            if (Test-Path $path) {
              Write-Host "✓ Found: $f"
            } else {
              Write-Error "✗ Missing: $f"
              exit 1
            }
          }
          
          # Check commands
          $cmds = @("git", "micro")
          foreach ($c in $cmds) {
            if (Get-Command $c -ErrorAction SilentlyContinue) {
              Write-Host "✓ Command available: $c"
            } else {
              Write-Warning "✗ Command missing: $c"
            }
          }
