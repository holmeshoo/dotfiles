name: Dotfiles CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      msg:
        type: string
        required: false
        description: "any message"


jobs:
  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      # - name: Uninstall pre-installed tools (Simulate fresh OS)
      #   run: |
      #     echo "Uninstalling Homebrew..."
      #     /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"
      #     sudo rm -f /etc/paths.d/homebrew
      #     sudo rm -rf /opt/homebrew
      #     echo "Uninstalling xcode..."
      #     sudo rm -rf /Library/Developer/CommandLineTools
      #     echo "Simulated a fresh macOS environment."

      - name: Setup Dotfiles (macOS)
        run: |
          # Use explicit flags for non-interactive setup in CI
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/holmeshoo/dotfiles/main/scripts/install.sh)" -- --core --runtime --fonts
        env:
          SUDO_ASKPASS: /usr/bin/true

      - name: Verify Installation (macOS)
        run: |
          export PATH="/opt/homebrew/bin:/usr/local/bin:$HOME/.local/bin:$PATH"
          bash scripts/verify.sh --core --runtime --fonts

  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Dotfiles (Linux)
        run: |
          # Use explicit flags for non-interactive setup in CI
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/holmeshoo/dotfiles/main/scripts/install.sh)" -- --core --runtime --fonts

      - name: Verify Installation (Linux)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          bash scripts/verify.sh --core --runtime --fonts

  test-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Dotfiles (Windows)
        shell: pwsh
        run: |
          # Windows execution
          .\windows\install.ps1
        env:
          CI: true

      - name: Verify Installation (Windows)
        shell: pwsh
        run: |
          $homeDir = $HOME
          Write-Host "Checking files in: $homeDir"
          
          # install.ps1 creates filenames like ".gitconfig" in the $HOME directory
          $files = @(".gitconfig", ".vimrc", ".editorconfig", ".functions")
          
          foreach ($f in $files) {
            $path = Join-Path $homeDir $f
            if (Test-Path $path) {
              Write-Host "✓ Found: $f ($path)" -ForegroundColor Green
            } else {
              Write-Host "✗ Missing: $f ($path)" -ForegroundColor Red
              # Debug: list all dotfiles in home
              Get-ChildItem -Path $homeDir -Filter ".*" | Select-Object Name
              exit 1
            }
          }
          
          # Check commands
          $cmds = @("git", "micro")
          foreach ($c in $cmds) {
            if (Get-Command $c -ErrorAction SilentlyContinue) {
              Write-Host "✓ Command available: $c" -ForegroundColor Green
            } else {
              Write-Warning "✗ Command missing: $c"
            }
          }
